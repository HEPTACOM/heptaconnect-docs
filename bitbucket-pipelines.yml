image: node:14-alpine

pipelines:
    branches:
        master:
            -   step:
                    name: Build docs
                    script:
                        - apk add --no-cache git make bash openssh-client
                        - make build
                        - git checkout -b gh-pages
                        - git add --all
                        - test $(git diff --name-only --cached | wc -l) -eq 0 || git commit -m "Build gh-pages"
                        - git push --force origin gh-pages
        gh-pages:
            -   step:
                    name: Skip for manual step
                    script:
                        - echo "hello"
            -   step:
                    name: Publish to github
                    deployment: production
                    trigger: manual
                    script:
                        - apk add --no-cache bash git openssh-client
                        - git remote add github git@github.com:HEPTACOM/heptaconnect-docs.git
                        - git config remote.origin.fetch "+refs/heads/*:refs/remotes/origin/*"
                        - git remote update
                        - git fetch --all
                        - git push --force github gh-pages
                        - git checkout --track origin/master
                        - git push --force github master
