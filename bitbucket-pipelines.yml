image: node:14-alpine

definitions:
    steps:
        -   step: &default
                artifacts:
                    - 'docs/**'
                clone:
                    depth: full
        -   step: &build-docs
                <<: *default
                caches:
                    - pip
                    - node
                artifacts:
                    - 'site/**'
                image: heptacom/mkdocs-pipeline
                name: Build documentation assets
                script:
                    - npm install --global cross-env
                    - npm ci --include=dev
                    - pip install -r requirements.txt
                    - PATH=.bin:$PATH make build
        -   step: &commit-built-docs
                <<: *default
                name: Commit docs
                artifacts:
                    - docs/meta-descriptions.csv
                script:
                    - apk add --update --no-cache git openssh-client
                    - mv .gh-pages-gitignore .gitignore
                    - git rm -r docs/
                    - rm -rf docs/
                    - mv site/ docs/
                    - git stash
                    - git checkout -b gh-pages
                    - git stash apply
                    - git add --all
                    - test $(git diff --name-only --cached | wc -l) -eq 0 || git commit -m "Build gh-pages"
                    - git push --force origin gh-pages
        -   step: &publish-docs
                <<: *default
                name: Publish to github
                script:
                    - apk add --update --no-cache git openssh-client rsync
                    - rsync -avz --delete -e ssh ./docs/ "${RSYNC_TARGET}"
                    - git remote add github git@github.com:HEPTACOM/heptaconnect-docs.git
                    - git config remote.origin.fetch "+refs/heads/*:refs/remotes/origin/*"
                    - git remote update
                    - git fetch --all
                    - git push --force github gh-pages
                    - git checkout --track origin/master
                    - git push --force github master
        -   step: &clear-cache
                clone:
                    enabled: false
                image: curlimages/curl:7.82.0
                name: Clear hosting cache
                script:
                    - |
                        curl -X POST "https://api.cloudflare.com/client/v4/zones/${CLOUDFLARE_ZONE_ID}/purge_cache" -H "Authorization: Bearer ${CLOUDFLARE_API_TOKEN}" -H "Content-Type: application/json" --data '{"purge_everything":true}'

pipelines:
    branches:
        master:
            -   step: *build-docs
            -   step: *commit-built-docs
        gh-pages:
            -   step:
                    name: Skip for manual step
                    script:
                        - echo "hello"
            -   step:
                    <<: *publish-docs
                    deployment: production
                    trigger: manual
            -   step: *clear-cache
    pull-requests:
        '**':
            -   step: *build-docs
